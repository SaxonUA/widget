<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>Віджет бою</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700;800&family=Russo+One&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg-color: rgba(0,0,0,0.0);
      --text-color:#ffffff;
      --glow-color:#4cba7a;

      --hp-bg: rgba(0,0,0,0.35);
      --hp-border: rgba(255,255,255,0.18);
      --hp-fill: #20c76a;

      --widget-width: 360px;

      /* однакова тінь для всього */
      --shadow: 0 0 6px rgba(0,0,0,0.95), 0 0 10px rgba(0,0,0,0.65), 0 0 6px var(--glow-color);
    }

    body{
      margin:0;
      padding:10px;
      height:100vh;
      background:var(--bg-color);
      color:var(--text-color);
      display:flex;
      justify-content:flex-start;
      align-items:flex-start;
    }

    .battle-widget{
      width: var(--widget-width);
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      gap:.5rem;
      font-family: "Montserrat", Arial, sans-serif;
      font-weight: 800;
    }

    /* ===== HP ===== */
    .hp-section{
      width: 100%;
      display:flex;
      flex-direction:column;
      gap:.3rem;
      margin-bottom: .05rem;
    }

    .hp-bar{
      width: 100%;
      height: 16px;
      position: relative;
      background: var(--hp-bg);
      border: 1px solid var(--hp-border);
      border-radius: 999px;
      overflow: hidden;
      box-shadow: 0 0 10px rgba(0,0,0,0.35);
    }

    .hp-fill{
      height: 100%;
      width: 0%;
      background: var(--hp-fill);
      box-shadow: 0 0 12px var(--glow-color);
      transition: width 200ms linear;
    }

    .hp-text{
      width: 100%;
      text-align:center;
      font-family: "Russo One", "Montserrat", Arial, sans-serif;
      font-size: 14px;
      letter-spacing: .4px;
      color: rgba(255,255,255,0.9);
      text-shadow: var(--shadow);
      user-select:none;
      white-space:nowrap;
      font-variant-numeric: tabular-nums;
      font-feature-settings: "tnum" 1;
    }

    /* ===== Stats ===== */
    .stat-block{
      display:flex;
      align-items:center;
      gap:.6rem;
    }

    .stat-label{
      width: 28px;
      display:flex;
      justify-content:center;
      align-items:center;
      opacity: .98;
    }

    /* ✅ тінь/світіння як у чисел */
    .stat-label svg{
      width: 18px;
      height: 18px;
      fill: #fff;
      display:block;
      filter:
        drop-shadow(0 0 6px rgba(0,0,0,0.95))
        drop-shadow(0 0 10px rgba(0,0,0,0.65))
        drop-shadow(0 0 6px var(--glow-color));
    }

    .stat-value{
      font-family: "Russo One", "Montserrat", Arial, sans-serif;
      font-size: 18px;
      min-width: 90px;
      letter-spacing: .2px;
      text-shadow: var(--shadow);
      font-variant-numeric: tabular-nums;
      font-feature-settings: "tnum" 1;
    }
  </style>
</head>

<body>
  <div class="battle-widget">

    <div class="hp-section">
      <div class="hp-bar">
        <div id="hp-fill" class="hp-fill"></div>
      </div>
      <div id="health-value" class="hp-text">0 / 0</div>
    </div>

    <!-- Мапа -->
    <div class="stat-block">
      <div class="stat-label" aria-hidden="true">
        <svg viewBox="0 0 24 24">
          <path d="M12 2c-3.9 0-7 3.1-7 7 0 5.2 6 12.6 6.3 12.9.4.5 1.1.5 1.5 0C13 21.6 19 14.2 19 9c0-3.9-3.1-7-7-7zm0 10a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/>
        </svg>
      </div>
      <div id="map-name" class="stat-value">-</div>
    </div>

    <!-- 1) Приціл = дамаг -->
    <div class="stat-block">
      <div class="stat-label" aria-hidden="true">
        <svg viewBox="0 0 24 24">
          <path d="M11 2h2v3a7.02 7.02 0 0 1 6 6h3v2h-3a7.02 7.02 0 0 1-6 6v3h-2v-3a7.02 7.02 0 0 1-6-6H2v-2h3a7.02 7.02 0 0 1 6-6V2zm1 6a4 4 0 1 0 0 8 4 4 0 0 0 0-8zm0 2a2 2 0 1 1 0 4 2 2 0 0 1 0-4z"/>
        </svg>
      </div>
      <div id="damage-value" class="stat-value">0</div>
    </div>

    <!-- 2) Око = насвіт -->
    <div class="stat-block">
      <div class="stat-label" aria-hidden="true">
        <svg viewBox="0 0 24 24">
          <path d="M12 5c5.5 0 9.7 4.1 11 7-1.3 2.9-5.5 7-11 7S2.3 15.9 1 12c1.3-2.9 5.5-7 11-7zm0 3a4 4 0 1 0 0 8 4 4 0 0 0 0-8zm0 2.2a1.8 1.8 0 1 1 0 3.6 1.8 1.8 0 0 1 0-3.6z"/>
        </svg>
      </div>
      <div id="assist-value" class="stat-value">0</div>
    </div>

    <!-- 3) Фраги -->
    <div class="stat-block">
      <div class="stat-label" aria-hidden="true">
        <svg viewBox="0 0 24 24">
          <path d="M12 2c-4.4 0-8 3.3-8 7.4 0 2.6 1.5 5 4 6.4V20c0 1.1.9 2 2 2h1v-3h2v3h1c1.1 0 2-.9 2-2v-4.2c2.5-1.4 4-3.8 4-6.4C20 5.3 16.4 2 12 2zm-3 9a1.2 1.2 0 1 1 0-2.4A1.2 1.2 0 0 1 9 11zm6 0a1.2 1.2 0 1 1 0-2.4A1.2 1.2 0 0 1 15 11zm-4 4h2v2h-2v-2z"/>
        </svg>
      </div>
      <div id="kills-value" class="stat-value">0</div>
    </div>

  </div>

<script>
  const MY_PLAYER_ID = 594841106;
  const WS_URL = "ws://localhost:38200";

  const mapEl    = document.getElementById("map-name");
  const damageEl = document.getElementById("damage-value");
  const assistEl = document.getElementById("assist-value");
  const killsEl  = document.getElementById("kills-value");

  const hpText = document.getElementById("health-value");
  const hpFill = document.getElementById("hp-fill");

  let ws;
  let reconnectTimer;

  let totalDamage = 0;
  let totalAssist = 0;
  let totalKills  = 0;

  let maxHP = 0;
  let curHP = 0;

  const fmt = n => Number(n).toLocaleString("uk-UA");
  const clamp = v => Math.max(0, Math.min(1, v));

  function updateHP(){
    hpText.textContent = `${fmt(curHP)} / ${fmt(maxHP)}`;
    if (!maxHP){
      hpFill.style.width = "0%";
      return;
    }
    hpFill.style.width = `${clamp(curHP / maxHP) * 100}%`;
  }

  function resetAll(){
    totalDamage = 0;
    totalAssist = 0;
    totalKills  = 0;
    maxHP = 0;
    curHP = 0;

    mapEl.textContent = "-";
    damageEl.textContent = "0";
    assistEl.textContent = "0";
    killsEl.textContent  = "0";
    updateHP();
  }

  function connectWS(){
    ws = new WebSocket(WS_URL);
    ws.onopen = () => clearTimeout(reconnectTimer);
    ws.onclose = () => reconnectTimer = setTimeout(connectWS, 1000);
    ws.onerror = () => ws.close();
    ws.onmessage = handleMessage;
  }

  function handleMessage(e){
    try{
      const p = JSON.parse(e.data);
      if (!p?.type || !p.path) return;

      if (p.type === "state"){
        switch(p.path){
          case "battle.arena":
            if (p.value?.localizedName) mapEl.textContent = p.value.localizedName;
            break;

          case "battle.efficiency.assist":
            totalAssist = Number(p.value) || 0;
            assistEl.textContent = fmt(totalAssist);
            break;

          case "battle.efficiency.kills":
            totalKills = Number(p.value) || 0;
            killsEl.textContent = fmt(totalKills);
            break;

          case "battle.maxHealth":
            maxHP = Number(p.value) || 0;
            updateHP();
            break;

          case "battle.health":
            curHP = Number(p.value) || 0;
            updateHP();
            break;

          case "hangar.isInHangar":
            document.body.style.display = p.value ? "none" : "flex";
            if (p.value) resetAll();
            break;
        }
      }

      if (p.type === "trigger" && p.path === "battle.onDamage"){
        if (p.value?.attacker?.playerId === MY_PLAYER_ID){
          totalDamage += Number(p.value.damage) || 0;
          damageEl.textContent = fmt(totalDamage);
        }
      }
    }catch(err){
      console.error(err);
    }
  }

  updateHP();
  connectWS();
</script>
</body>
</html>
