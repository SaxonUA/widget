<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>–í—ñ–¥–∂–µ—Ç –±–æ—é</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    :root{
      --bg-color: rgba(0,0,0,0.0);
      --text-color:#fff;
      --glow-color:#4cba7a;
      --hp-bg:rgba(255,255,255,0.15);
      --hp-fill:#ff6a00;
    }
    body{
      background:var(--bg-color);
      color:var(--text-color);
      font-family:Arial,sans-serif;
      margin:0;padding:1rem;
      justify-content:flex-start;align-items:flex-start;
      height:100vh;transition:opacity .5s ease-in-out;
    }
    .battle-widget{
      display:flex;flex-direction:column;align-items:flex-start;gap:.3rem;
      font-size:1.2rem;font-weight:bold;width:360px;
    }
    .stat-block{display:flex;align-items:center;gap:.5rem;}
    .stat-label{
      font-size:1.4rem;min-width:30px;text-align:center;
      display:flex;justify-content:center;align-items:center;
    }
    .stat-label i{color:var(--glow-color);filter:drop-shadow(0 0 12px var(--glow-color));}
    .stat-label img{width:22px;height:22px;filter:drop-shadow(0 0 8px var(--glow-color));}
    .stat-value{
      font-size:1.4rem;color:#fff;min-width:80px;text-align:left;
      text-shadow:0 0 6px var(--glow-color);
    }
    /* HP */
    .hp-section{display:flex;flex-direction:column;width:100%;gap:.25rem;margin-top:.5rem;}
    .hp-nickname{font-size:1.2rem;font-weight:bold;text-shadow:0 0 6px var(--glow-color);margin-bottom:.2rem;}
    .hp-bar{position:relative;width:100%;height:10px;background:var(--hp-bg);border-radius:999px;overflow:hidden;box-shadow:inset 0 0 8px rgba(0,0,0,.35);}
    .hp-fill{height:100%;width:0%;background:var(--hp-fill);box-shadow:0 0 12px var(--glow-color);transition:width 200ms linear;}
    .hp-text{font-size:1.2rem;text-shadow:0 0 6px var(--glow-color);}
  </style>
</head>
<body>
  <div class="battle-widget">
    <div class="stat-block">
      <div class="stat-label"><i class="fas fa-location-dot"></i></div>
      <div id="map-name" class="stat-value">-</div>
    </div>

    <!-- Damage –∑ PNG —ñ –∑–∞–ø–∞—Å–Ω–∏–º FA-—ñ–∫–æ–Ω–∫–æ—é -->
    <div class="stat-block">
      <div class="stat-label">
        <img id="damage-icon" src="./damage.png" alt="Damage"
             onerror="this.onerror=null;this.remove();document.getElementById('damage-fa').style.display='inline-flex';console.warn('damage.png not found');">
        <i id="damage-fa" class="fas fa-xmark" style="display:none"></i>
      </div>
      <div id="damage-value" class="stat-value">0</div>
    </div>

    <div class="stat-block">
      <div class="stat-label"><i class="fas fa-eye"></i></div>
      <div id="assist-value" class="stat-value">0</div>
    </div>
    <div class="stat-block">
      <div class="stat-label"><i class="fas fa-skull-crossbones"></i></div>
      <div id="kills-value" class="stat-value">0</div>
    </div>

    <!-- HP –≤–Ω–∏–∑—É -->
    <div class="hp-section">
      <div id="player-name" class="hp-nickname">–ù—ñ–∫–Ω–µ–π–º</div>
      <div id="hp-bar" class="hp-bar" role="progressbar" aria-label="–ó–¥–æ—Ä–æ–≤'—è" aria-valuemin="0" aria-valuemax="0" aria-valuenow="0">
        <div id="hp-fill" class="hp-fill"></div>
      </div>
      <div id="health-value" class="hp-text">0 / 0</div>
    </div>
  </div>

  <script>
    const MY_PLAYER_ID = 594841106;
    const damageEl = document.getElementById("damage-value");
    const assistEl = document.getElementById("assist-value");
    const mapNameEl = document.getElementById("map-name");
    const killsEl = document.getElementById("kills-value");
    const healthEl = document.getElementById("health-value");
    const hpBar = document.getElementById("hp-bar");
    const hpFill = document.getElementById("hp-fill");
    const playerNameEl = document.getElementById("player-name");

    const ws = new WebSocket("ws://localhost:38200");

    let totalDamage = 0, totalAssist = 0, totalKills = 0;
    let maxHealth = 0, currentHealth = 0;

    const formatNum = n => Number(n).toLocaleString('uk-UA');
    const clamp01 = x => Math.max(0, Math.min(1, x));

    function updateHealthDisplay(){
      healthEl.textContent = `${formatNum(currentHealth)} / ${formatNum(maxHealth)}`;
      const pct = maxHealth > 0 ? clamp01(currentHealth / maxHealth) : 0;
      hpFill.style.width = `${pct * 100}%`;
      hpBar.setAttribute('aria-valuemax', String(maxHealth));
      hpBar.setAttribute('aria-valuenow', String(currentHealth));
    }

    ws.onopen = () => console.log("‚úÖ WebSocket –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ");
    ws.onerror = err => console.error("‚ùå WebSocket –ø–æ–º–∏–ª–∫–∞", err);
    ws.onclose = () => console.warn("üîå WebSocket –≤—ñ–¥–∫–ª—é—á–µ–Ω–æ");

    ws.addEventListener("message", (event) => {
      try{
        const payload = JSON.parse(event.data);
        if(!payload || !payload.type || !payload.path) return;

        if(payload.type === 'state'){
          switch(payload.path){
            case 'battle.arena':
              if(payload.value?.localizedName) mapNameEl.textContent = payload.value.localizedName;
              break;
            case 'battle.efficiency.assist':
              totalAssist = payload.value || 0;
              assistEl.textContent = formatNum(totalAssist);
              break;
            case 'battle.efficiency.kills':
              totalKills = payload.value || 0;
              killsEl.textContent = formatNum(totalKills);
              break;
            case 'battle.maxHealth':
              maxHealth = Number(payload.value) || 0;
              updateHealthDisplay();
              break;
            case 'battle.health':
              currentHealth = Number(payload.value) || 0;
              updateHealthDisplay();
              break;
            case 'battle.playerName':
              if(payload.value) playerNameEl.textContent = payload.value;
              break;
            case 'hangar.isInHangar':
              const inHangar = payload.value;
              document.body.style.display = inHangar ? 'none' : 'flex';
              if(inHangar){
                totalDamage = totalAssist = totalKills = 0;
                currentHealth = maxHealth = 0;
                damageEl.textContent = '0';
                assistEl.textContent = '0';
                killsEl.textContent = '0';
                mapNameEl.textContent = '-';
                playerNameEl.textContent = '–ù—ñ–∫–Ω–µ–π–º';
                updateHealthDisplay();
              }
              break;
          }
        }

        if(payload.type === 'trigger' && payload.path === 'battle.onDamage'){
          const data = payload.value;
          const attacker = data?.attacker;
          if(attacker && attacker.playerId === MY_PLAYER_ID){
            totalDamage += Number(data.damage) || 0;
            damageEl.textContent = formatNum(totalDamage);
          }
        }
      }catch(e){ console.error("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ–±—Ä–æ–±—Ü—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è", e); }
    });
  </script>
</body>
</html>
