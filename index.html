<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>–í—ñ–¥–∂–µ—Ç –±–æ—é</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    :root{
      --bg-color: rgba(0,0,0,0.0);
      --text-color:#fff;
      --glow-color:#4cba7a;
      --hp-bg:rgba(255,255,255,0.15);
      --hp-fill:#ff6a00;
    }
    body{
      background:var(--bg-color);
      color:var(--text-color);
      font-family:Arial,sans-serif;
      margin:0;padding:1rem;
      justify-content:flex-start;align-items:flex-start;
      height:100vh;
    }
    .battle-widget{
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      gap:.3rem;
      font-size:1.2rem;
      font-weight:bold;
      width:360px;
    }
    .stat-block{display:flex;align-items:center;gap:.5rem;}
    .stat-label{
      font-size:1.4rem;min-width:30px;
      display:flex;justify-content:center;align-items:center;
    }
    .stat-label i{
      color:#fff;
      filter: drop-shadow(0 0 8px var(--glow-color));
    }
    .stat-label img{
      width:22px;height:22px;
      filter: brightness(0) invert(1) drop-shadow(0 0 8px var(--glow-color));
    }
    .stat-value{
      font-size:1.4rem;
      min-width:80px;
      text-shadow:0 0 6px var(--glow-color);
    }

    .hp-section{
      display:flex;
      flex-direction:column;
      gap:.25rem;
      margin-bottom:.5rem;
    }
    .hp-nickname{
      font-size:1.2rem;
      text-shadow:0 0 6px var(--glow-color);
    }
    .hp-bar{
      width:50%;
      height:10px;
      background:var(--hp-bg);
      border-radius:999px;
      overflow:hidden;
    }
    .hp-fill{
      height:100%;
      width:0%;
      background:var(--hp-fill);
      box-shadow:0 0 12px var(--glow-color);
      transition:width 200ms linear;
    }
    .hp-text{
      font-size:1.2rem;
      text-shadow:0 0 6px var(--glow-color);
    }
  </style>
</head>

<body>
<div class="battle-widget">

  <div class="hp-section">
    <div id="player-name" class="hp-nickname">SaXon_UA</div>
    <div id="hp-bar" class="hp-bar">
      <div id="hp-fill" class="hp-fill"></div>
    </div>
    <div id="health-value" class="hp-text">0 / 0</div>
  </div>

  <div class="stat-block">
    <div class="stat-label"><i class="fas fa-location-dot"></i></div>
    <div id="map-name" class="stat-value">-</div>
  </div>

  <div class="stat-block">
    <div class="stat-label">
      <img src="./damage.png" alt="Damage"
        onerror="this.remove();document.getElementById('damage-fa').style.display='inline-flex';">
      <i id="damage-fa" class="fas fa-xmark" style="display:none"></i>
    </div>
    <div id="damage-value" class="stat-value">0</div>
  </div>

  <div class="stat-block">
    <div class="stat-label"><i class="fas fa-eye"></i></div>
    <div id="assist-value" class="stat-value">0</div>
  </div>

  <div class="stat-block">
    <div class="stat-label"><i class="fas fa-skull-crossbones"></i></div>
    <div id="kills-value" class="stat-value">0</div>
  </div>

</div>

<script>
  const MY_PLAYER_ID = 594841106;
  const WS_URL = "ws://localhost:38200";

  const damageEl = document.getElementById("damage-value");
  const assistEl = document.getElementById("assist-value");
  const killsEl  = document.getElementById("kills-value");
  const mapEl    = document.getElementById("map-name");
  const hpText   = document.getElementById("health-value");
  const hpFill   = document.getElementById("hp-fill");
  const playerEl = document.getElementById("player-name");

  let ws;
  let reconnectTimer;

  let totalDamage = 0;
  let totalAssist = 0;
  let totalKills  = 0;
  let maxHP = 0;
  let curHP = 0;

  const fmt = n => Number(n).toLocaleString("uk-UA");
  const clamp = v => Math.max(0, Math.min(1, v));

  function updateHP(){
    if (!maxHP) return;
    hpText.textContent = `${fmt(curHP)} / ${fmt(maxHP)}`;
    hpFill.style.width = `${clamp(curHP / maxHP) * 100}%`;
  }

  function resetAll(){
    totalDamage = totalAssist = totalKills = 0;
    maxHP = curHP = 0;
    damageEl.textContent = assistEl.textContent = killsEl.textContent = "0";
    mapEl.textContent = "-";
    playerEl.textContent = "SaXon_UA";
    updateHP();
  }

  function connectWS(){
    console.log("üîÑ WS connect...");
    ws = new WebSocket(WS_URL);

    ws.onopen = () => {
      console.log("‚úÖ WS connected");
      clearTimeout(reconnectTimer);
    };

    ws.onclose = () => {
      console.warn("üîå WS closed ‚Üí retry");
      reconnectTimer = setTimeout(connectWS, 1000);
    };

    ws.onerror = () => ws.close();

    ws.onmessage = handleMessage;
  }

  function handleMessage(e){
    try{
      const p = JSON.parse(e.data);
      if (!p?.type || !p.path) return;

      if (p.type === "state"){
        switch(p.path){
          case "battle.arena":
            if (p.value?.localizedName) mapEl.textContent = p.value.localizedName;
            break;

          case "battle.efficiency.assist":
            assistEl.textContent = fmt(totalAssist = p.value || 0);
            break;

          case "battle.efficiency.kills":
            killsEl.textContent = fmt(totalKills = p.value || 0);
            break;

          case "battle.maxHealth":
            maxHP = Number(p.value) || 0;
            updateHP();
            break;

          case "battle.health":
            curHP = Number(p.value) || 0;
            updateHP();
            break;

          case "battle.playerName":
            if (p.value) playerEl.textContent = p.value;
            break;

          case "hangar.isInHangar":
            document.body.style.display = p.value ? "none" : "flex";
            if (p.value) resetAll();
            break;
        }
      }

      if (p.type === "trigger" && p.path === "battle.onDamage"){
        if (p.value?.attacker?.playerId === MY_PLAYER_ID){
          totalDamage += Number(p.value.damage) || 0;
          damageEl.textContent = fmt(totalDamage);
        }
      }
    }catch(err){
      console.error("‚ùó WS parse error", err);
    }
  }

  connectWS();
</script>
</body>
</html>
